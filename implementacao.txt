# üìã PROMPT RESUMIDO - Sistema de Or√ßamentos e Controle Financeiro

## CONTEXTO
Sistema de agendamentos de sal√£o de beleza em Next.js 14+ (App Router) precisa adicionar:
- Sistema de or√ßamentos 
- Controle financeiro completo (contas a receber/pagar, fluxo de caixa, DRE, comiss√µes)

---

## 1. TIPOS TYPESCRIPT (types/orcamento.ts + types/financeiro.ts)

```typescript
interface Template {
  id: string
  nome: string
  config: {
    cor_primaria: string
    cor_secundaria: string
    layout: 'moderno'|'minimalista'|'elegante'
    exibir_logo: boolean
    logo_url?: string
    dados_empresa: { nome, endereco, telefone, email, cnpj, site }
    secoes: { observacoes, termos_condicoes, forma_pagamento, validade }
  }
  conteudo_padrao: { observacoes, termos_condicoes, mensagem_agradecimento }
}

interface Orcamento {
  id: string
  numero: string // ORC-2025-001
  template_id: string
  cliente: { id, nome, email, telefone }
  itens: [{ servico_id, servico_nome, quantidade, valor_unitario, desconto, subtotal }]
  data_emissao: Date
  data_validade: Date
  subtotal: number
  desconto: number
  valor_total: number
  status: 'pendente'|'aprovado'|'rejeitado'|'expirado'
}

interface ContaReceber {
  id: string
  numero: string // CR-2025-001
  cliente_id: string
  agendamento_id?: string
  orcamento_id?: string
  valor_original: number
  data_vencimento: Date
  data_pagamento?: Date
  status: 'pendente'|'pago'|'atrasado'
  forma_pagamento: string
}

interface ContaPagar {
  id: string
  categoria: 'comissao'|'aluguel'|'produto'|'salario'|'outros'
  profissional_id?: string
  valor_original: number
  data_vencimento: Date
  status: 'pendente'|'pago'
  recorrente: boolean
}

interface Comissao {
  id: string
  profissional_id: string
  periodo: { inicio: Date, fim: Date }
  atendimentos: [{ agendamento_id, valor_servico, valor_comissao }]
  total_comissao: number
  bonificacoes: number
  valor_final: number
  status: 'calculado'|'aprovado'|'pago'
}
```

---

## 2. ESTRUTURA DE PASTAS

```
app/
‚îú‚îÄ‚îÄ orcamentos/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                    # Lista + filtros
‚îÇ   ‚îú‚îÄ‚îÄ novo/page.tsx               # Wizard 3 steps (template‚Üídados‚Üípreview)
‚îÇ   ‚îú‚îÄ‚îÄ [id]/page.tsx               # Ver or√ßamento
‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ       ‚îú‚îÄ‚îÄ page.tsx                # Grid de templates
‚îÇ       ‚îî‚îÄ‚îÄ [id]/page.tsx           # Editor visual split-screen
‚îú‚îÄ‚îÄ financeiro/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                    # Dashboard (cards + gr√°fico fluxo)
‚îÇ   ‚îú‚îÄ‚îÄ contas-receber/page.tsx     # Lista com status coloridos
‚îÇ   ‚îú‚îÄ‚îÄ contas-pagar/page.tsx       # Lista + despesas recorrentes
‚îÇ   ‚îú‚îÄ‚îÄ fluxo-caixa/page.tsx        # Gr√°fico linha + extrato
‚îÇ   ‚îú‚îÄ‚îÄ dre/page.tsx                # Relat√≥rio DRE formatado
‚îÇ   ‚îî‚îÄ‚îÄ comissoes/page.tsx          # Config + c√°lculo autom√°tico
components/
‚îú‚îÄ‚îÄ orcamentos/
‚îÇ   ‚îú‚îÄ‚îÄ TemplateSelector.tsx        # Grid clic√°vel
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ModernoTemplate.tsx     # Header gradiente + tabela zebrada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MinimalistaTemplate.tsx # Clean, borders finas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EleganteTemplate.tsx    # Corporativo
‚îÇ   ‚îî‚îÄ‚îÄ ModalEnvio.tsx              # WhatsApp/Email/PDF
‚îú‚îÄ‚îÄ financeiro/
‚îÇ   ‚îú‚îÄ‚îÄ ModalReceber.tsx            # Registrar recebimento
‚îÇ   ‚îú‚îÄ‚îÄ FluxoCaixaChart.tsx         # Recharts: 3 linhas (entrada/sa√≠da/saldo)
‚îÇ   ‚îî‚îÄ‚îÄ DRERelatorio.tsx            # Formata√ß√£o com quebras
```

---

## 3. FUNCIONALIDADES PRINCIPAIS

### A) OR√áAMENTOS

**Wizard Cria√ß√£o (app/orcamentos/novo/page.tsx)**
- **Step 1**: TemplateSelector (grid com preview miniatura)
- **Step 2**: Formul√°rio
  - Select cliente
  - Tabela itens din√¢mica: [+Adicionar] Select Servi√ßo | Qtd | Valor | Desconto | Subtotal calculado | [Remover]
  - Totalizadores tempo real: Subtotal ‚Üí Desconto % ‚Üí TOTAL
  - Observa√ß√µes + Forma Pagamento + Data Validade
- **Step 3**: Preview do template renderizado + bot√µes [Salvar Rascunho] [Salvar e Enviar]

**Editor Template (app/orcamentos/templates/[id]/page.tsx)**
- **Painel Esquerdo (360px fixo)**:
  - Inputs: Nome, Descri√ß√£o
  - Color pickers: cor_primaria, cor_secundaria
  - Selects: layout, fontes, espa√ßamento
  - Checkboxes: exibir_logo, secoes ativas
  - Textareas: dados_empresa, conteudo_padrao
- **Painel Direito (flex-1)**: Preview ao vivo com dados mock + bot√£o [Exportar PDF Teste]

**Templates React**
- ModernoTemplate: Header gradiente, tabela bg-alternado, total com background cor_primaria
- MinimalistaTemplate: Borders finas, font-light, uppercase labels, clean
- EleganteTemplate: Corporativo, serifas, sombras suaves

### B) FINANCEIRO

**Dashboard (app/financeiro/page.tsx)**
- 4 Cards: Saldo Atual | A Receber | A Pagar | Atrasadas
- Gr√°fico Recharts: LineChart com 3 linhas (verde/vermelho/azul)
- Se√ß√£o alertas: üî¥ Vencidas | üü° Hoje | üü¢ Pr√≥ximas
- Atalhos: [Registrar Recebimento] [Registrar Pagamento] [Ver DRE]

**Contas a Receber (app/financeiro/contas-receber/page.tsx)**
- Cards resumo: Pendente | Recebido | Atrasado
- Lista organizada por status (accordions coloridos)
- Cada conta: Cliente | Valor | Vencimento | [Cobrar WhatsApp] [Receber] [Negociar]
- Modal Receber: Inputs data, forma_pagamento, descontos, acr√©scimos ‚Üí [Confirmar]

**Fluxo de Caixa (app/financeiro/fluxo-caixa/page.tsx)**
- Seletor per√≠odo: Di√°rio|Semanal|Mensal|Anual
- Gr√°fico grande: 3 linhas (entradas/sa√≠das/saldo acumulado)
- Cards: Total Entradas | Sa√≠das | Saldo | Varia√ß√£o %
- Extrato tabela: Data | Tipo | Categoria | Entrada | Sa√≠da | Saldo
- Bot√µes: [Exportar Excel] [Exportar PDF]

**DRE (app/financeiro/dre/page.tsx)**
- Select M√™s/Ano
- Relat√≥rio formatado:
  ```
  RECEITA BRUTA          R$ XX
  (-) Descontos          R$ XX
  = RECEITA L√çQUIDA      R$ XX
  (-) CUSTOS SERVI√áOS    R$ XX
  = LUCRO BRUTO          R$ XX (Margem: XX%)
  (-) DESPESAS OPERAC.   R$ XX
  = RESULTADO FINAL      R$ XX (Margem: XX%)
  ```
- Gr√°ficos: Pizza (custos por categoria) + Barras (evolu√ß√£o 6 meses)
- Tabela comparativa mensal

**Comiss√µes (app/financeiro/comissoes/page.tsx)**
- Aba 1 - Configura√ß√£o: Tabela profissionais com [Configurar]
  - Modal config: Tipo (percentual|fixo|hibrido), meta_minima, bonus, dia_pagamento
- Aba 2 - Comiss√µes do M√™s:
  - Cards: Profissional | Atendimentos | Faturamento | Comiss√£o | B√¥nus | TOTAL | Status
  - Bot√µes: [Ver Detalhes] [Aprovar] [Gerar Pagamento]
  - "Gerar Pagamento" cria ContaPagar automaticamente

---

## 4. AUTOMA√á√ïES E TRIGGERS

```typescript
// TRIGGER: Ao finalizar agendamento
async function aoFinalizarAgendamento(agendamento) {
  // Criar ContaReceber automaticamente
  await criarContaReceber({
    agendamento_id: agendamento.id,
    valor_original: agendamento.valor_total,
    status: agendamento.pago_no_ato ? 'pago' : 'pendente'
  })
  
  // Se pago, registrar fluxo caixa
  if (agendamento.pago_no_ato) {
    await registrarFluxoCaixa({ tipo: 'entrada', valor: agendamento.valor_total })
  }
}

// JOB DI√ÅRIO (9h): Verificar vencimentos
async function jobVencimentos() {
  // Contas vencendo hoje ‚Üí enviar lembretes WhatsApp
  // Contas vencidas ‚Üí atualizar status para 'atrasado'
  // Or√ßamentos expirados ‚Üí atualizar status
}

// JOB MENSAL (dia 5, 6h): Calcular comiss√µes
async function calcularComissoesMensais() {
  for (profissional of profissionais) {
    const atendimentos = await buscarAtendimentos(profissional, mesAnterior)
    
    let comissao = {
      total_comissao: atendimentos.reduce((acc, a) => 
        acc + (a.valor * config.percentual / 100), 0
      )
    }
    
    // Aplicar b√¥nus se ultrapassou meta
    if (config.tipo === 'hibrido' && total_faturado > meta_minima) {
      comissao.bonificacoes = (total_faturado - meta_minima) * (bonus / 100)
    }
    
    await salvarComissao(comissao)
    await notificarProfissional(profissional)
  }
}
```

---

## 5. API ROUTES ESSENCIAIS

```typescript
// Or√ßamentos
GET/POST    /api/orcamentos
GET/PUT/DEL /api/orcamentos/[id]
POST        /api/orcamentos/[id]/aprovar
POST        /api/orcamentos/[id]/converter-agendamento
GET         /api/orcamentos/proximo-numero
POST        /api/orcamentos/gerar-pdf         // @react-pdf/renderer
POST        /api/orcamentos/enviar            // WhatsApp API / Nodemailer

// Templates
GET/POST    /api/orcamentos/templates
GET/PUT/DEL /api/orcamentos/templates/[id]

// Financeiro
GET/POST    /api/financeiro/contas-receber
POST        /api/financeiro/contas-receber/[id]/receber
GET/POST    /api/financeiro/contas-pagar
POST        /api/financeiro/contas-pagar/[id]/pagar
GET         /api/financeiro/fluxo-caixa       // Query: data_inicio, data_fim
GET         /api/financeiro/dre               // Query: mes, ano
GET/POST    /api/financeiro/comissoes
POST        /api/financeiro/comissoes/calcular-mensal
```

---

## 6. C√ÅLCULOS IMPORTANTES

```typescript
// DRE
const receitaLiquida = receitaBruta - deducoes
const lucroBruto = receitaLiquida - (comissoes + produtos)
const margemBruta = (lucroBruto / receitaLiquida) * 100
const resultadoOperacional = lucroBruto - despesasOperacionais
const margemLiquida = (resultadoOperacional / receitaLiquida) * 100

// Fluxo de Caixa
const fluxoPorData = {}
entradas.forEach(c => fluxo[data].entradas += c.valor)
saidas.forEach(c => fluxo[data].saidas += c.valor)
let saldoAcumulado = 0
Object.keys(fluxo).sort().forEach(data => {
  saldoAcumulado += (fluxo[data].entradas - fluxo[data].saidas)
  fluxo[data].saldo = saldoAcumulado
})

// Comiss√£o H√≠brida
const comissaoBase = faturamento * (percentual_base / 100)
const bonus = faturamento > meta_minima 
  ? (faturamento - meta_minima) * (bonus_percentual / 100) 
  : 0
const total = comissaoBase + bonus
```

---

## 7. CHECKLIST DE IMPLEMENTA√á√ÉO

**Fase 1 - Or√ßamentos (Semana 1-2)**
- [ ] Criar tipos TypeScript
- [ ] 1 template React (Minimalista)
- [ ] Wizard de cria√ß√£o (3 steps com progress)
- [ ] Editor visual de template (split-screen)
- [ ] Lista de or√ßamentos com filtros
- [ ] Modal envio (WhatsApp/Email/PDF)
- [ ] API routes CRUD or√ßamentos + templates
- [ ] Gera√ß√£o PDF (@react-pdf/renderer)

**Fase 2 - Financeiro (Semana 3-4)**
- [ ] Dashboard financeiro com cards + gr√°fico
- [ ] Contas a Receber (lista + modal registrar)
- [ ] Contas a Pagar (lista + despesas recorrentes)
- [ ] Fluxo de Caixa (gr√°fico + extrato)
- [ ] DRE mensal (relat√≥rio + comparativo)
- [ ] Comiss√µes (config + c√°lculo autom√°tico)
- [ ] Triggers: agendamento‚Üíconta_receber
- [ ] Jobs: verificar vencimentos + calcular comiss√µes
- [ ] API routes financeiro completo

**Fase 3 - Integra√ß√µes (Semana 5)**
- [ ] WhatsApp Business API
- [ ] Email service (Nodemailer/SendGrid)
- [ ] Exporta√ß√£o Excel/PDF
- [ ] Notifica√ß√µes push/email
- [ ] Testes e ajustes

---

## 8. BIBLIOTECAS NECESS√ÅRIAS

```bash
npm install @react-pdf/renderer
npm install recharts
npm install date-fns
npm install react-colorful
npm install nodemailer
npm install xlsx # para exportar Excel
```

---

## 9. OBSERVA√á√ïES IMPORTANTES

‚úÖ **Usar portugu√™s (PT-BR)** em toda interface
‚úÖ **Formato monet√°rio**: `toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })`
‚úÖ **Formato data**: `format(date, 'dd/MM/yyyy', { locale: ptBR })`
‚úÖ **Cores status**: üî¥ Atrasado | üü° Hoje | üü¢ Futuro | ‚úÖ Pago
‚úÖ **Responsivo**: Mobile-first com Tailwind
‚úÖ **Loading states**: Skeleton ou spinners
‚úÖ **Valida√ß√µes**: Zod nos formul√°rios
‚úÖ **Feedback**: Toast notifications (react-hot-toast)

---

**PROMPT PARA IA**: "Com base nesta especifica√ß√£o resumida, implemente o sistema completo de Or√ßamentos e Controle Financeiro em Next.js 14+. Crie todos os arquivos mencionados (types, pages, components, API routes) seguindo as estruturas e funcionalidades descritas. Use TypeScript, Tailwind CSS, e as bibliotecas indicadas. Priorize c√≥digo limpo, componentizado e reutiliz√°vel."